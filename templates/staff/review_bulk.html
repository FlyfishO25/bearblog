{% extends 'base.html' %}
{% load custom_tags %}

{% block favicon %}ðŸš®{% endblock %}

{% block title %}Review flow{% endblock %}


{% block heading %}Review flow{% endblock %}

{% block seo %}
<meta name="robots" content="noindex">
{% endblock %}

{% block custom_styles %}
{% include 'snippets/styles.html' %}
body {
    font-size: 10px;
}

.controls {
    display: flex;
    justify-content: space-between;
}

.controls button {
    font-size: 17px;
    padding: 10px;
    border-radius: 5px;
    border: none;
}
{% endblock %}

{% block content %}
<a href="{% url 'staff_dashboard' %}">Back</a>
<h3>Still to go: {{ still_to_go }}</h3>
<hr>

{% for blog in blogs %}
<div id="blog-{{ blog.pk }}">
    <h3>{{ blog.title }}</h3>
    <a href="{{ blog.useful_domain }}" target="_blank">{{ blog.useful_domain }}</a>
    <br>
    <a href="mailto:{{ blog.user.email }}">{{ blog.user.email }}</a>
    <p><b>
        Created {{ blog.created_date | timesince }} ago
        <br>
        Last modified {{ blog.last_modified | timesince }} ago
        <br>
        Last posted {{ blog.last_posted | timesince }} ago
    </b></p>

    <nav>{{ blog.nav | markdown:blog | safe }}</nav>
    {{ blog.content | markdown:blog | safe }}


    <ul style="padding-bottom: 30px; max-height: 500px; overflow: auto; border: 1px dashed">
        {% for post in blog.posts.all %}
        <li>
            <i>
                <time datetime="{{ post.published_date|date:'Y-m-d' }}">
                    - {{ post.published_date|date:'d M, Y' }}
                </time>
            </i>
            <h3><a href="{{ root }}/{{ post.slug }}/" target="_blank">{{ post.title }}</a></h3>
            <p>
                {{ post.content | markdown:post | safe }}
            </p>
        </li>
        {% endfor %}
    </ul>

    {% if blog.reviewer_note %}
    <p style="color: darkgreen">
        {{ blog.reviewer_note }}
    </p>
    {% endif %}
    <details>
        <summary>Optional message</summary>
        <textarea class="message" style="width: 100%; height: 100px; padding: 10px;">
Hey, I've just reviewed your blog. It looks good and has been approved.
<br>
<br>
Have a great week!
<br>
Herman
        </textarea>
    </details>
    <br>
    <div class="controls">
        <button onclick="approveBlogWithEmail({{ blog.pk }})">Approve and email</button>
        <button onclick="approveBlog({{ blog.pk }})">Approve</button>
        <button onclick="ignoreBlog({{ blog.pk }})">Ignore</button>
        <button onclick="blockBlog({{ blog.pk }})">Block</button>
        <button onclick="deleteBlog({{ blog.pk }})">Delete</button>
    </div>

    <hr>
</div>
{% endfor %}
<button onclick="window.scrollTo(0, 0); setTimeout(function() { window.location.reload(); }, 10)">Next â€ºâ€º</button>
{% endblock %}

{% block footer %}
<script>
    function highlightKeywords(keywords) {
        const regex = new RegExp(keywords.join('|'), 'gi');
        const elements = document.getElementsByTagName('*');
        
        for (const element of elements) {
            if (element.childNodes.length === 1 && element.childNodes[0].nodeType === Node.TEXT_NODE) {
            const text = element.textContent;
            const matches = text.match(regex);
            
            if (matches) {
                const newElement = document.createElement('span');
                newElement.innerHTML = text.replace(regex, '<mark>$&</mark>');
                element.parentNode.replaceChild(newElement, element);
            }
            }
        }
    }
        
    const keywords = ['seo', 'marketing', 'backlink', 'crypto', 'blockchain', 'coins', 'tokens'];
    highlightKeywords(keywords);

    function approveBlogWithEmail(pk) {
        message = document.querySelector(`#blog-${pk} .message`).value

        document.querySelector(`#blog-${pk}`).style.background="lightgreen"
        fetch(`/staff/review/approve/${pk}?message=${message}`, {
            method: 'GET',
        })
        .then(data => console.log(data))
        .catch(error => console.error('Error:', error));
    }
    function approveBlog(pk) {
        document.querySelector(`#blog-${pk}`).style.background="lightgreen"
        fetch(`/staff/review/approve/${pk}`, {
            method: 'GET'
        })
        .then(data => console.log(data))
        .catch(error => console.error('Error:', error));
    }
    function ignoreBlog(pk) {
        document.querySelector(`#blog-${pk}`).style.background="lightyellow"
        fetch(`/staff/review/ignore/${pk}`, {
            method: 'GET'
        })
        .then(data => console.log(data))
        .catch(error => console.error('Error:', error));
    }
    function blockBlog(pk) {
        document.querySelector(`#blog-${pk}`).style.background="orange"
        fetch(`/staff/review/block/${pk}`, {
            method: 'GET'
        })
        .then(data => console.log(data))
        .catch(error => console.error('Error:', error));
    }
    function deleteBlog(pk) {
        if (confirm('Delete this blog?')) {
            document.querySelector(`#blog-${pk}`).style.background="grey"
            fetch(`/staff/review/delete/${pk}`, {
                method: 'GET'
            })
            .then(data => console.log(data))
            .catch(error => console.error('Error:', error));
        }
    }
</script>

{% endblock %}