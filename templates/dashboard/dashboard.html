{% extends 'base.html' %}

{% block title %}
    Dashboard | Bear Blog
{% endblock %}

{% block nav %}
{% include '../snippets/dashboard_nav.html' %}
{% endblock %}

{% block content %}
<content>
    <h1>Home page</h1>

    <p>
        <input type="text" value="required" required style="width: 70px; font-size: 10px;" readonly/>
        <input type="text" value="optional" style="width: 70px; font-size: 10px;" readonly/>
    </p>

    <form method="POST" class="post-form full-width">{% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="save btn btn-default">Save</button>
    </form>

    {% if blog %}
    <p>
        View site: <a href="{{ root }}" target="_blank">{{ root }}</a>
        <br>
        RSS feed: <a href="{{ root }}/feed/" target="_blank">{{ root }}/feed/</a>
    </p>
    {% endif %}
</content>
<input type="file" id="file" hidden accept="image/*">
<script>
    document.querySelector('#toggle-full-screen').onclick = event => {
        event.preventDefault()
        document.querySelector('textarea').classList.toggle('full-screen')
        event.target.classList.toggle('floating')
    }
    
    {% if blog.upgraded %}
    document.querySelector('#upload-image').onclick = event => {
        event.preventDefault()
        document.getElementById("file").click()
    }

    document.getElementById("file").addEventListener("change", upload)

    function upload() {
        if(document.getElementById("file").files[0].size > 2000000){
            alert(`File over the 2mb limit. Use https://tinypng.com to minimise it.`)
            return
        }

        var formData = new FormData();
        var target = '/dashboard/upload-image/'
        formData.append("file", document.getElementById("file").files[0])
        var xhr = new XMLHttpRequest()
        var eventSource = xhr.upload || xhr
        eventSource.addEventListener("progress", function(e){
            var current = e.loaded || e.position
            var total = e.total || e.totalSize
            var percent = parseInt((current/total)*100, 10)
            alert('Uploading...')
        });
        xhr.open("POST", target, true)
        xhr.send(formData)
        xhr.onload = function() {
            if (this.status === 200) {
                textarea = document.querySelector('textarea')
                textarea.value += '\n\n![Image title]('+this.responseText+')'
                alert('The image has been added to the bottom of your content')
            }
                
        };
    }
    {% else %}
    document.querySelector('#upload-image').style.display = 'none'
    {% endif %}
</script>
{% endblock %}